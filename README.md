# Microservice Architecture Simulation

## Оглавление

- [Описание](#описание)
- [Техническое задание (ТЗ)](#техническое-задание-тз)
- [Структура проекта](#структура-проекта)
- [Установка и запуск](#установка-и-запуск)
- [Настройка параметров](#настройка-параметров)
- [Визуализация результатов](#визуализация-результатов)

## Описание

Данный проект представляет собой симуляцию микросервисной архитектуры на языке Python. Он позволяет экспериментировать с различными параметрами системы, проводить аналитику и визуализировать зависимости между компонентами системы.

## Техническое задание (ТЗ)

**Микросервисная архитектура приложения**

Рассмотрим архитектуру микросервиса, состоящую из четырех компонентов:

- **Служба P**: Хранит персонализированную информацию. Идентификатор представляет человека и некоторые метаданные, связанные с этим человеком. Для простоты будем считать, что хранимые метаданные никогда не бывают очень большими, и люди никогда не удаляются из системы. P передает данные в Q для сохранения.

- **Служба Q**: Универсальная служба хранения данных, используемая несколькими вышестоящими службами. Она хранит данные в постоянной базе данных для обеспечения отказоустойчивости и восстановления, а также в кешированной базе данных на основе памяти для быстрого доступа.

- **Служба S**: Постоянная база данных, возможно, столбчатая система хранения, такая как Cassandra или DynamoDB.

- **Служба T**: Кеш в памяти, возможно, что-то вроде Redis или Memcached.

### Сценарий сбоя

Однажды служба T выходит из строя. Поиск в P начинает замедляться, потому что Q обнаруживает, что T больше не отвечает, и поэтому перенаправляет все запросы на чтение в S. К сожалению, службы с большими кешами обычно имеют высокие требования к скорости чтения. В этом случае служба T хорошо справлялась с нагрузкой, но S не может обработать внезапное увеличение рабочей нагрузки. Работа S замедляется и в конечном итоге полностью прекращается, возвращая ошибку 404 [Not Found].

Служба P знает, что человек, которого она ищет, точно существует, потому что у нее есть ID. Люди никогда не удаляются из службы P, поэтому ответ 404, который P получает от Q, является неприемлемым. Служба P не знает, как реагировать на этот невозможный ответ и падает, увлекая за собой всю систему.

### Цель

Симулировать описанную выше микросервисную архитектуру, исследовать ее поведение при различных параметрах, провести аналитику и визуализировать результаты.

## Структура проекта

```
microservice_simulation/
├── README.md
├── .gitignore
├── requirements.txt
├── config.yaml
├── services/
│   ├── __init__.py
│   ├── service_p.py
│   ├── service_q.py
│   ├── service_s.py
│   └── service_t.py
├── simulation.py
└── visualization.py
```

- **README.md**: Этот файл с описанием проекта и инструкциями.
- **.gitignore**: Файл с исключениями для Git.
- **requirements.txt**: Список необходимых зависимостей.
- **config.yaml**: Конфигурационный файл для настройки параметров системы.
- **services/**: Пакет с реализациями служб P, Q, S и T.
- **simulation.py**: Главный скрипт для запуска симуляции.
- **visualization.py**: Скрипт для визуализации результатов симуляции.

## Установка и запуск

Создайте виртуальное окружение (рекомендуется) и установите зависимости из `requirements.txt`:

```bash
python3 -m venv venv
source venv/bin/activate  # Для Linux/Mac
# или
venv\Scripts\activate  # Для Windows

pip install -r requirements.txt
```

Чтобы запустить симуляцию с параметрами по умолчанию:

```bash
python simulation.py
```

Вы увидите вывод с результатами симуляции:

```
Успешных запросов: X, Сбоев: Y
```

## Настройка параметров

Все параметры системы настраиваются в файле `config.yaml`. Изменяя этот файл, вы можете управлять поведением симуляции без изменения кода.

### Структура `config.yaml`

```yaml
simulation:
  num_requests: 1000  # Количество запросов в симуляции

services:
  service_t:
    is_down: False        # Флаг недоступности службы T
    failure_rate: 0.0     # Вероятность отказа службы T (от 0 до 1)
    response_time: 0.0    # Время отклика службы T в секундах

  service_s:
    is_overloaded: False  # Флаг перегрузки службы S
    failure_rate: 0.0     # Вероятность отказа службы S (от 0 до 1)
    response_time: 0.0    # Время отклика службы S в секундах

  service_p:
    expect_404: False     # Ожидает ли служба P ответ 404 (False - падает при 404)
```

### Пояснение параметров

- **simulation.num_requests**: Общее количество запросов, которые будут отправлены службой P в ходе симуляции.

#### Параметры службы T (кеш в памяти)

- **services.service_t.is_down**: Если `True`, служба T считается недоступной и все запросы к ней будут завершаться с ошибкой.
- **services.service_t.failure_rate**: Вероятность отказа службы T при каждом запросе. Значение от `0.0` (без отказов) до `1.0` (постоянные отказы).
- **services.service_t.response_time**: Время в секундах, которое служба T затрачивает на обработку каждого запроса. Используется для моделирования задержек.

#### Параметры службы S (постоянное хранилище)

- **services.service_s.is_overloaded**: Если `True`, служба S считается перегруженной и все запросы к ней будут завершаться с ошибкой.
- **services.service_s.failure_rate**: Вероятность отказа службы S при каждом запросе.
- **services.service_s.response_time**: Время отклика службы S в секундах.

#### Параметры службы P

- **services.service_p.expect_404**: Если `False`, служба P не ожидает ответа 404 и падает при его получении (имитирует описанный сбой). Если `True`, служба P корректно обрабатывает ответ 404.

### Пример изменения параметров

#### Сценарий: Служба T недоступна

Чтобы смоделировать ситуацию, когда служба T недоступна, измените параметр `is_down` для службы T:

```yaml
services:
  service_t:
    is_down: True
```

#### Сценарий: Служба T недоступна, служба S перегружена

```yaml
services:
  service_t:
    is_down: True

  service_s:
    is_overloaded: True
```

#### Сценарий: Служба T имеет вероятность отказа 30%

```yaml
services:
  service_t:
    failure_rate: 0.3
```

После изменения параметров сохраните файл `config.yaml` и запустите симуляцию снова:

```bash
python simulation.py
```

## Визуализация результатов

Скрипт `visualization.py` позволяет визуализировать результаты симуляции для разных сценариев.

### Запуск визуализации

```bash
python visualization.py
```

Скрипт выполнит симуляции для заданных сценариев и отобразит графики с результатами.

### Добавление собственных сценариев

Вы можете добавить свои сценарии в файл `visualization.py` в список `scenarios`:

```python
scenarios = [
    # Существующие сценарии
    {
        'name': 'Все службы работают',
        'config_updates': {}
    },
    # Ваш новый сценарий
    {
        'name': 'Служба T отказ 50%',
        'config_updates': {
            'services': {
                'service_t': {'failure_rate': 0.5}
            }
        }
    }
]
```

После добавления новых сценариев запустите `visualization.py` снова для обновления графиков.
